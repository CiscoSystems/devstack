# OpenDaylight
# -------
#
# This file implements functions required to configure a host with Open
# vSwitch to work with the OpenDaylight controller.
#
# * enable_service opendaylight
#
# Configurable options include:
#
# * ODL_LOCAL_IP
# * ODL_MGR_IP
# * ODL_MGR_PORT
#

# Save trace setting
MY_XTRACE=$(set +o | grep xtrace)
set +o xtrace

function configure_opendaylight() {
    :
}

function init_opendaylight() {
    ODL_LOCAL_IP=${ODL_LOCAL_IP:-$HOST_IP}
    if [ "$ODL_MGR_IP" == "" ]; then
        ODL_MGR_IP=$(grep url /$Q_PLUGIN_CONF_FILE | sed -e s'/.*\/\///'g -e 's/\:.*//'g)
    fi
    ODL_MGR_PORT=${ODL_MGR_PORT:-6640}
    read ovstbl <<< $(sudo ovs-vsctl get Open_vSwitch . _uuid)

    # Set the OVSDB manager connection to point at OpenDaylight
    sudo ovs-vsctl set-manager tcp:$ODL_MGR_IP:$ODL_MGR_PORT

    # Set the IP used by OpenDaylight for tunnel configuration 
    sudo ovs-vsctl set Open_vSwitch $ovstbl other_config={"local_ip"="$ODL_LOCAL_IP"}
}

function install_opendaylight() {
    :
}

function start_opendaylight() {
    :
}

function stop_opendaylight() {
    # Remove the OVSDB manager connection
    sudo ovs-vsctl del-manager

    # Remove OpenFlow connection for each bridge
    BRIDGES=$(sudo ovs-vsctl list-br)
    for bridge in $BRIDGES ; do
        sudo ovs-vsctl del-controller $bridge
    done
}

function check_opendaylight() {
    :
}

# Restore xtrace
$MY_XTRACE


